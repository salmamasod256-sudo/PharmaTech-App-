
const GEMINI_API_KEY = "AIzaSyAWed2TPgkRr7HYw_h1XP7bkXfBcfY5Ymk"; // Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
const firebaseConfig = {
    apiKey: "AIzaSyD9RK5RW_iU00BDReNtv1yE-EJZX8CFxKk",
    authDomain: "pharmatec-app-fc845.firebaseapp.com",
    projectId: "pharmatec-app-fc845",
    storageBucket: "pharmatec-app-fc845.firebasestorage.app",
    messagingSenderId: "818569012835",
    appId: "1:818569012835:web:fc165b4b5141171feb3a56"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase Ù„Ù„Ø´Ø§Øª
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const myID = localStorage.getItem('user_id') || 'User_' + Math.floor(Math.random() * 9999);
localStorage.setItem('user_id', myID);

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© (ØªÙ… ØªØ­Ù…ÙŠÙ„ drugs.js)
if (typeof drugDB === 'undefined') {
    console.error("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù drugs.js");
    alert("ØªÙ†Ø¨ÙŠÙ‡: Ù…Ù„Ù drugs.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! Ø§Ù„Ø¨Ø­Ø« Ù„Ù† ÙŠØ¹Ù…Ù„.");
    var drugDB = []; 
}

// ---------------- 1. Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ----------------
function changePage(p) {
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    document.querySelectorAll('[id^="page-"]').forEach(el => el.style.display = 'none');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const targetPage = document.getElementById('page-' + p);
    if (targetPage) {
        targetPage.style.display = 'flex';
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ù„Ø¨Ø¹Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
    if (p === 'chat') {
        loadChat();
    }
}

// ---------------- 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡ ----------------
function searchDrug(query) {
    const suggestionsBox = document.getElementById('suggestions-box');
    suggestionsBox.innerHTML = '';
    
    if (!query || query.length < 2) {
        suggestionsBox.style.display = 'none';
        return; 
    }

    const lowerQuery = query.toLowerCase();
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠØŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ Ø§Ù„Ø¹Ù„Ù…ÙŠØŒ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    const matches = drugDB.filter(d => 
        (d.trade_name && d.trade_name.toLowerCase().includes(lowerQuery)) || 
        (d.ar_name && d.ar_name.includes(query)) || 
        (d.barcode && d.barcode === query)
    );

    if (matches.length > 0) {
        suggestionsBox.style.display = 'block';
        // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø· Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø£Ø¯Ø§Ø¡
        matches.slice(0, 10).forEach(drug => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `<strong>${drug.trade_name}</strong><br><small>${drug.ar_name}</small>`;
            div.onclick = () => selectDrug(drug);
            suggestionsBox.appendChild(div);
        });
    } else {
        suggestionsBox.style.display = 'none';
    }
}

function selectDrug(drug) {
    document.getElementById('drugName').value = drug.trade_name;
    // ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙƒÙ€ Ù†Øµ JSON ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
    document.getElementById('selectedDrugId').value = JSON.stringify(drug);
    document.getElementById('suggestions-box').style.display = 'none';
}

// ---------------- 3. Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¹Ø±Ø¶ ----------------
function calculateAndShow() {
    const drugInput = document.getElementById('drugName').value;
    const weight = parseFloat(document.getElementById('weight').value);
    const selectedDrugData = document.getElementById('selectedDrugId').value;

    if (!weight || weight <= 0) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©.");
        return;
    }

    let drug = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (selectedDrugData) {
        try {
            drug = JSON.parse(selectedDrugData);
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡", e);
        }
    } 
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹
    if (!drug) {
        drug = drugDB.find(d => 
            d.trade_name.toLowerCase() === drugInput.toLowerCase() || 
            d.ar_name === drugInput
        );
    }

    if (drug) {
        renderDrugResult(drug, weight);
    } else {
        renderGenericResult(drugInput, weight);
    }
    
    changePage('result');
}

function renderDrugResult(drug, weight) {
    document.getElementById('resDrugName').innerHTML = `${drug.trade_name}<br><span style="font-size:0.7em; color:#666;">${drug.ar_name}</span>`;
    
    let doseInfo = "";
    
    // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¨: (Ø§Ù„ÙˆØ²Ù† * Ø§Ù„Ø¬Ø±Ø¹Ø© Ù„ÙƒÙ„ ÙƒØ¬Ù…) / ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¯ÙˆØ§Ø¡
    if (drug.type === 'syrup' && drug.math && drug.math.dose_mg_kg > 0 && drug.math.conc_mg_ml > 0) {
        const doseML = (weight * drug.math.dose_mg_kg) / drug.math.conc_mg_ml;
        doseInfo = `ğŸ§ª Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: <strong>${doseML.toFixed(1)} Ù…Ù„</strong> ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©`;
    } 
    // Ù„Ù„Ø£Ù‚Ø±Ø§Øµ ÙˆØ§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø§Øª
    else if (drug.type === 'tablet' || drug.type === 'capsule') {
        doseInfo = `ğŸ’Š Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø©: Ù‚Ø±Øµ ÙˆØ§Ø­Ø¯ (Ø£Ùˆ Ø­Ø³Ø¨ ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ¨)`;
    } 
    // Ù„Ù„Ø¨Ø§Ù‚ÙŠ (Ù…Ø±Ø§Ù‡Ù…ØŒ Ø­Ù‚Ù†...)
    else {
        doseInfo = `âš ï¸ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${drug.usage}`;
    }

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„ØªØ­Ø°ÙŠØ±
    const frequency = (drug.math && drug.math.max_freq_day) ? `${drug.math.max_freq_day} Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰` : 'Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©';
    const warningText = drug.warning ? drug.warning : "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø°ÙŠØ±Ø§Øª Ø®Ø§ØµØ©.";

    document.getElementById('result-list').innerHTML = `
        <li><strong>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> ${drug.usage}</li>
        <li>${doseInfo}</li>
        <li><strong>Ø§Ù„ØªÙƒØ±Ø§Ø±:</strong> ${frequency}</li>
        <li style="color:#d9534f; font-weight:bold;"><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ${warningText}</li>
    `;
}

function renderGenericResult(name, weight) {
    // Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ (Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙ‚Ø·)
    const dose = name.toLowerCase().includes('para') ? weight * 15 : weight * 10;
    
    document.getElementById('resDrugName').innerText = name + " (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)";
    document.getElementById('result-list').innerHTML = `
        <li>ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù‚Ø©.</li>
        <li>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ù‡ Ø®Ø§ÙØ¶ Ø­Ø±Ø§Ø±Ø©): ${dose} Ù…Ù„Øº ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹.</li>
        <li>ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©.</li>
    `;
}

// ---------------- 4. Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (QR) ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI) ----------------
function showScanner() { 
    document.getElementById('scannerOverlay').style.display = 'flex'; 
}

function hideScanner() { 
    document.getElementById('scannerOverlay').style.display = 'none'; 
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„ (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©)
    try {
        if(window.html5QrCode) {
            window.html5QrCode.stop().catch(err => {});
        }
    } catch(e) {}
}

function triggerAIFile() { 
    document.getElementById('aiInput').click(); 
}

function startQRScan() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø­ Ø¬Ø§Ø±ÙŠ
    const readerElement = document.getElementById("qr-reader-content");
    readerElement.innerHTML = ""; 

    const html5QrCode = new Html5Qrcode("qr-reader-content");
    window.html5QrCode = html5QrCode; // ØªØ®Ø²ÙŠÙ†Ù‡ Ù„Ù„ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹

    const config = { fps: 10, qrbox: 250 };
    
    html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
        // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
        html5QrCode.stop().then(() => {
            hideScanner();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const drug = drugDB.find(d => d.barcode === decodedText);
            
            if (drug) {
                selectDrug(drug);
                alert(`âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰: ${drug.ar_name}`);
            } else {
                document.getElementById('drugName').value = decodedText;
                alert("âš ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹.");
            }
        });
    }).catch(err => {
        console.log(err);
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©.");
    });
}

async function analyzePrescriptionAI(input) {
    const file = input.files[0];
    if (!file) return;
    
    hideScanner();
    document.getElementById('loading-overlay').style.display = 'flex';

    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = async () => {
        const base64 = reader.result.split(',')[1]; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø·
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        const prompt = `Ø£Ù†Øª ØµÙŠØ¯Ù„ÙŠ Ø®Ø¨ÙŠØ±. Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙÙ‚Ø· Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
        Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø§Ù„Ø¶Ø¨Ø·: <div class="ai-item"><span class="ai-key">Ø§Ù„Ø§Ø³Ù…:</span><span class="ai-val drug-detect">[Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§]</span></div>`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    contents: [{ 
                        parts: [
                            { text: prompt }, 
                            { inlineData: { mimeType: file.type, data: base64 } } 
                        ] 
                    }] 
                })
            });
            
            const data = await res.json();
            
            if (data.candidates && data.candidates.length > 0) {
                const text = data.candidates[0].content.parts[0].text.replace(/```html|```/g, "");
                
                document.getElementById('ai-content').innerHTML = text;
                document.getElementById('ai-result-box').style.display = 'block';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
                setTimeout(() => {
                    const detectedElement = document.querySelector('.drug-detect');
                    if (detectedElement) {
                        const detectedName = detectedElement.innerText.trim();
                        document.getElementById('drugName').value = detectedName;
                        searchDrug(detectedName); // Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
                    }
                }, 500);
            } else {
                alert("Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØ¶ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.");
            }

        } catch (e) { 
            console.error(e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª."); 
        }
        
        document.getElementById('loading-overlay').style.display = 'none';
    };
}

// ---------------- 5. Ø§Ù„Ø´Ø§Øª ----------------
function loadChat() {
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø©)
    db.collection("public_chat").orderBy("timestamp", "asc").limitToLast(50).onSnapshot(snap => {
        const box = document.getElementById('chatBody');
        box.innerHTML = '';
        snap.forEach(doc => {
            const m = doc.data();
            const isMe = m.senderID === myID;
            box.innerHTML += `<div class="message ${isMe ? 'me' : 'other'}">${m.text}</div>`;
        });
        // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        box.scrollTop = box.scrollHeight;
    });
}

function sendMessage() {
    const inp = document.getElementById('chatInput');
    const text = inp.value.trim();
    
    if (text) {
        db.collection("public_chat").add({ 
            text: text, 
            senderID: myID, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        }).catch(err => {
            console.error("Error sending message: ", err);
        });
        inp.value = '';
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ (ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
window.onload = () => changePage('index');
```
